<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyAuth Clone</title>
    <style>
        :root {
            --bg-main: #1e1e2e; --bg-panel: #27293d; --text-primary: #cad3f5; --text-secondary: #a5b0d8;
            --accent: #89b4fa; --danger: #ed8796; --success: #a6da95; --border-color: #363a4f;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-main); color: var(--text-primary); font-size: 16px; }
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-panel { background-color: var(--bg-panel); padding: 2.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 350px; }
        .dashboard-container { display: none; grid-template-columns: 250px 1fr; min-height: 100vh; }
        .sidebar { background-color: var(--bg-panel); padding: 1.5rem; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { margin: 0; font-size: 1.5rem; }
        .sidebar-nav { margin-top: 2rem; }
        .sidebar-nav a { display: block; padding: 0.8rem 1rem; color: var(--text-secondary); text-decoration: none; border-radius: 5px; margin-bottom: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-nav a.active, .sidebar-nav a:hover { background-color: var(--accent); color: var(--bg-main); }
        .main-content { padding: 2rem; }
        .content-view { display: none; }
        .content-view.active { display: block; }
        h2, h3 { margin-top: 0; }
        input, select { box-sizing: border-box; width: 100%; padding: 12px; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-main); color: var(--text-primary); }
        button { width: 100%; padding: 12px; border: none; background-color: var(--accent); color: var(--bg-main); border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: background-color 0.2s; }
        button.danger { background-color: var(--danger); }
        button.small { padding: 8px 12px; font-size: 0.9rem; width: auto; margin-left: 10px; }
        button:hover { filter: brightness(1.1); }
        .info-box { background-color: var(--bg-main); padding: 1rem; border-radius: 5px; margin-bottom: 1rem; border: 1px solid var(--border-color); word-wrap: break-word; }
        .info-box strong { color: var(--accent); display: block; margin-bottom: 8px; }
        .info-box code { font-family: monospace; }
        .card { background-color: var(--bg-panel); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 1rem; }
        .message { margin-top: 1rem; text-align: center; font-weight: bold; min-height: 20px; }
        a { color: #89b4fa; text-decoration: none; }
        .modal-backdrop { display: none; position: fixed; z-index: 100; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--bg-panel); padding: 2rem; border-radius: 8px; width: 90%; max-width: 700px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .user-list-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="auth-view" class="auth-container">
        <div class="auth-panel">
            <div id="login-form">
                <h2>Seller Login</h2>
                <input type="text" id="login-username" placeholder="Seller Username">
                <input type="password" id="login-password" placeholder="Password">
                <button onclick="login()">Login</button>
                <p style="text-align:center; margin-top:1rem;">No account? <a href="#" onclick="showRegisterForm()">Register here</a></p>
            </div>
            <div id="register-form" style="display:none;">
                <h2>Seller Register</h2>
                <input type="text" id="reg-username" placeholder="Seller Username">
                <input type="password" id="reg-password" placeholder="Password">
                <button onclick="register()">Register</button>
                <p style="text-align:center; margin-top:1rem;">Have an account? <a href="#" onclick="showLoginForm()">Login here</a></p>
            </div>
            <p id="auth-message" class="message"></p>
        </div>
    </div>
    <div id="dashboard-view" class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2 id="sidebar-username">User</h2></div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" onclick="showView('dashboard')">Dashboard</a>
                <a href="#" class="nav-link" onclick="showView('applications')">Applications</a>
            </nav>
        </aside>
        <main class="main-content">
            <div id="dashboard-content" class="content-view active">
                <h2>Dashboard Home</h2>
                <div class="card">
                    <h3>Your Seller Details</h3>
                    <div class="info-box">
                        <strong>Your Account ID (OwnerID):</strong>
                        <code id="ownerid-display"></code>
                    </div>
                </div>
            </div>
            <div id="applications-content" class="content-view">
                <h2>Manage Applications</h2>
                <div class="card">
                    <h3>Create New Application</h3>
                    <input type="text" id="app-name" placeholder="Name of your application">
                    <button onclick="createApp()">Create Application</button>
                </div>
                <h3>Your Applications</h3>
                <div id="apps-list"></div>
            </div>
        </main>
    </div>

    <!-- User Management Modal -->
    <div id="manage-users-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-app-name">Manage Users</h2>
                <button class="small danger" onclick="closeModal()">Close</button>
            </div>
            <div id="user-list-container"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://lynxauth.onrender.com';
        let loggedInOwnerId = null;
        let loggedInUsername = null;

        function showView(viewName) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}-content`).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-nav a[onclick="showView('${viewName}')"]`).classList.add('active');
        }
        function showRegisterForm() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }
        function showLoginForm() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        }
        function openModal() { document.getElementById('manage-users-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('manage-users-modal').style.display = 'none'; }
        
        async function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            await apiCall('/register', { username, password }, 'auth-message', 'Registration successful! Please login.');
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const data = await apiCall('/login', { username, password }, 'auth-message', 'Login successful!');
            if (data && data.status === 'success') {
                loggedInOwnerId = data.ownerid;
                loggedInUsername = username;
                document.getElementById('auth-view').style.display = 'none';
                document.getElementById('dashboard-view').style.display = 'grid';
                document.getElementById('sidebar-username').textContent = username;
                document.getElementById('ownerid-display').textContent = loggedInOwnerId;
                loadApps();
            }
        }

        async function createApp() {
            const app_name = document.getElementById('app-name').value;
            if (!app_name) return alert('Please enter an application name.');
            await apiCall('/apps/create', { ownerid: loggedInOwnerId, app_name });
            document.getElementById('app-name').value = '';
            loadApps();
        }
        
        async function loadApps() {
            const data = await apiCall('/apps/list', { ownerid: loggedInOwnerId });
            const appsListDiv = document.getElementById('apps-list');
            appsListDiv.innerHTML = '';
            if (data && data.apps && data.apps.length > 0) {
                data.apps.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${app.name}</h3>
                        <div class="info-box"><strong>App Secret:</strong><code>${app.app_secret}</code></div>
                        <hr style="border-color:#333;">
                        <h4>Create End-User for this App</h4>
                        <input type="text" id="user-username-${app.appid}" placeholder="End-User's Username">
                        <input type="text" id="user-password-${app.appid}" placeholder="End-User's Password">
                        <input type="number" id="user-days-${app.appid}" placeholder="Subscription Days (0 for lifetime)" value="30">
                        <button onclick="createEndUser('${app.appid}')">Create User</button>
                        <hr style="border-color:#333; margin: 1.5rem 0;">
                        <button class="danger" onclick="manageUsers('${app.appid}', '${app.name}')">Manage Users</button>
                    `;
                    appsListDiv.appendChild(card);
                });
            } else {
                 appsListDiv.innerHTML = '<p>No applications created yet.</p>';
            }
        }
        
        async function createEndUser(appid) {
            const username = document.getElementById(`user-username-${appid}`).value;
            const password = document.getElementById(`user-password-${appid}`).value;
            const days = document.getElementById(`user-days-${appid}`).value;
            if(!username || !password) return alert("Please provide a username and password.");
            
            const data = await apiCall('/users/create', { ownerid: loggedInOwnerId, appid, username, password, days: parseInt(days) });
            if (data && data.status === 'success') {
                alert(`User '${username}' has been created successfully!`);
                document.getElementById(`user-username-${appid}`).value = '';
                document.getElementById(`user-password-${appid}`).value = '';
            }
        }

        async function manageUsers(appid, appName) {
            document.getElementById('modal-app-name').textContent = `Manage Users for ${appName}`;
            const userListContainer = document.getElementById('user-list-container');
            userListContainer.innerHTML = 'Loading...';
            openModal();
            
            const data = await apiCall('/users/list', { appid });
            
            if (data && data.users && data.users.length > 0) {
                userListContainer.innerHTML = '';
                data.users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'user-list-item';
                    const expiryDate = new Date(user.expires_at).toLocaleString();
                    item.innerHTML = `
                        <div>
                            <strong>${user.username}</strong><br>
                            <small>Expires: ${expiryDate}</small>
                        </div>
                        <div>
                            <input type="number" id="extend-days-${user.id}" placeholder="Days" value="30" style="width: 80px; display: inline-block; vertical-align: middle;">
                            <button class="small" onclick="extendUser(${user.id}, '${appid}', '${appName}')">Extend</button>
                            <button class="small danger" onclick="deleteUser(${user.id}, '${appid}', '${appName}')">Delete</button>
                        </div>
                    `;
                    userListContainer.appendChild(item);
                });
            } else {
                userListContainer.innerHTML = '<p>No users have been created for this application yet.</p>';
            }
        }

        async function deleteUser(userId, appid, appName) {
            if (confirm('Are you sure you want to delete this user? This cannot be undone.')) {
                await apiCall('/users/delete', { user_id: userId });
                await manageUsers(appid, appName); // Refresh the list
            }
        }

        async function extendUser(userId, appid, appName) {
            const daysInput = document.getElementById(`extend-days-${userId}`);
            const days = daysInput.value;
            if (!days || parseInt(days) <= 0) return alert('Please enter a valid number of days to extend.');
            
            await apiCall('/users/extend', { user_id: userId, days: parseInt(days) });
            await manageUsers(appid, appName); // Refresh the list
        }

        async function apiCall(endpoint, body, messageElId, successMessage) {
            const messageEl = document.getElementById(messageElId || 'message');
            try {
                const response = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (response.ok) {
                    if(successMessage && messageEl) messageEl.textContent = successMessage;
                    return data;
                } else {
                    if(messageEl) messageEl.textContent = `Error: ${data.detail}`;
                    return null;
                }
            } catch (error) {
                if(messageEl) messageEl.textContent = 'Error: Could not connect to the server.';
                console.error("API Call Error:", error);
                return null;
            }
        }
    </script>
</body>

</html>
